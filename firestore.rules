rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    
    // User profiles - allow users to read their own, admins to read all
    match /users/{uid} {
      allow read: if request.auth != null && 
        (request.auth.uid == uid || 
         resource.data.role == 'admin' || 
         resource.data.role == 'owner');
      allow write: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && 
        (resource.data.role == 'admin' || resource.data.role == 'owner');
    }

    // CRITICAL: Roles collection - allow ALL authenticated users to read
    match /roles/{roleId} {
      allow read: if request.auth != null;
      allow write: if false; // Only allow writes through admin interface later
    }

    // CRITICAL: Permissions collection - allow ALL authenticated users to read  
    match /permissions/{permissionId} {
      allow read: if request.auth != null;
      allow write: if false; // Only allow writes through admin interface later
    }
    
    // Allow admins to list users
    match /users/{document=**} {
      allow list: if request.auth != null;
    }

    // Temporary: Allow all reads for debugging (remove later)
    match /{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}